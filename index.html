<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIX</title>
<style>
* { box-sizing:border-box; margin:0; padding:0; font-family:system-ui; }

body { background:#004d33; color:white; min-height:100vh; }

header{
  background:#000;
  padding:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logo{ font-size:30px; font-weight:800; color:#39ff14; }

.search{ 
  width:calc(50% - 20px); 
  padding:10px 14px; 
  border-radius:16px; 
  border:none; 
  background:#1a1a1a; 
  color:white; 
}

main{
  padding:18px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:16px;
  justify-items:center;
  overflow-y:auto;
  max-height:calc(100vh - 100px);
}

.note{
  background:#000;
  width:100%;
  border-radius:20px;
  padding:14px;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
  font-weight:600;
  text-align:left;
  cursor:pointer;
}

.note h4{ margin-bottom:8px; }

/* ADD */
.add-btn{
  position:fixed;
  bottom:22px;
  right:22px;
  width:64px;
  height:64px;
  border-radius:50%;
  background:#000;
  color:#004d33;
  font-size:36px;
  border:none;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:flex-start;
  overflow-y:auto;
  padding:30px 0;
  z-index:100;
}

.modal.active{ display:flex; }

.card{
  background:#0f0f0f;
  width:95%;
  max-width:480px;
  border-radius:26px;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:14px;
  max-height:90vh;
  overflow-y:auto;
  position:relative;
}

#closeModal{
  position:absolute;
  top:10px;
  right:10px;
  background:rgba(0,0,0,0.7);
  border:none;
  color:white;
  font-size:22px;
  width:32px;
  height:32px;
  border-radius:50%;
  cursor:pointer;
}

/* MEDIA */
.media-view{
  width:100%;
  max-height:300px;
  background:#1c1c1c;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  border-radius:16px;
  position:relative;
}

.media-view img, .media-view video{
  max-width:100%;
  max-height:100%;
}

.media-controls{
  display:flex;
  justify-content:center;
  gap:12px;
  margin-top:10px;
}

.media-btn{
  background:#1a1a1a;
  border:none;
  width:40px;
  height:40px;
  border-radius:50%;
  font-size:20px;
  color:white;
  cursor:pointer;
}

/* INPUTS */
input,textarea{
  background:#2c2c2c;
  border:none;
  border-radius:16px;
  padding:12px;
  color:white;
}

textarea{
  resize:none;
  min-height:200px;
  max-height:400px;
  overflow-y:auto;
}

/* ACTIONS */
.actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.btn{
  flex:1;
  padding:12px;
  border-radius:18px;
  border:none;
  background:#222;
  color:white;
  font-weight:600;
}

.delete{ background:#ff3b3b; }

</style>
</head>
<body>

<header>
  <div class="logo">DIX</div>
  <input class="search" placeholder="–ü–æ–∏—Å–∫">
</header>

<main id="notes"></main>

<button class="add-btn">+</button>

<div class="modal" id="modal">
  <div class="card" id="card">
    <button id="closeModal">‚úñ</button>
    <input id="title" placeholder="–¢–µ–º–∞">
    <textarea id="text" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏"></textarea>

    <div class="media-view" id="mediaView">–ù–µ—Ç –º–µ–¥–∏–∞</div>
    <div class="media-controls">
      <button class="media-btn" id="prevMedia">‚óÄ</button>
      <button class="media-btn" id="addMediaBtn">üì∏</button>
      <button class="media-btn" id="nextMedia">‚ñ∂</button>
    </div>

    <input type="file" id="media" multiple accept="image/*,video/*" style="display:none;">

    <div class="actions">
      <button class="btn delete" id="delete">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn" id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
let db;
let currentId=null;
let mediaArr=[];
let mediaIndex=0;

const notesEl=document.getElementById('notes');
const modal=document.getElementById('modal');
const card=document.getElementById('card');
const titleInput=document.getElementById('title');
const textInput=document.getElementById('text');
const mediaInput=document.getElementById('media');
const mediaView=document.getElementById('mediaView');

const addMediaBtn=document.getElementById('addMediaBtn');
const prevMedia=document.getElementById('prevMedia');
const nextMedia=document.getElementById('nextMedia');
const closeModal=document.getElementById('closeModal');

// IndexedDB
const openDB=()=>new Promise(resolve=>{
  const req=indexedDB.open('DIX_DB',1);
  req.onupgradeneeded=e=>{
    db=e.target.result;
    db.createObjectStore('notes',{ keyPath:'id', autoIncrement:true });
  };
  req.onsuccess=e=>{ db=e.target.result; resolve(); };
});

const getAllNotes=()=>new Promise(resolve=>{
  const tx=db.transaction('notes','readonly');
  const req=tx.objectStore('notes').getAll();
  req.onsuccess=()=>resolve(req.result);
});

const addNote=note=>new Promise(resolve=>{
  const tx=db.transaction('notes','readwrite');
  const store=tx.objectStore('notes');
  if(currentId==null) store.add(note);
  else store.put({...note,id:currentId});
  tx.oncomplete=resolve;
});

const deleteNote=id=>new Promise(resolve=>{
  const tx=db.transaction('notes','readwrite');
  tx.objectStore('notes').delete(id);
  tx.oncomplete=resolve;
});

// Base64
const fileToBase64=file=>new Promise((res,rej)=>{
  const reader=new FileReader();
  reader.readAsDataURL(file);
  reader.onload=()=>res(reader.result);
  reader.onerror=e=>rej(e);
});

addMediaBtn.onclick=()=>mediaInput.click();
mediaInput.onchange=async()=>{
  const files=[...mediaInput.files];
  for(const f of files){
    const base64=await fileToBase64(f);
    mediaArr.push({type:f.type,url:base64});
  }
  mediaIndex=mediaArr.length-1;
  showMedia();
};

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–¥–∏–∞
prevMedia.onclick=()=>{ if(mediaArr.length>0){ mediaIndex=(mediaIndex-1+mediaArr.length)%mediaArr.length; showMedia(); }};
nextMedia.onclick=()=>{ if(mediaArr.length>0){ mediaIndex=(mediaIndex+1)%mediaArr.length; showMedia(); }};

function showMedia(){
  if(mediaArr.length===0){ mediaView.innerHTML='–ù–µ—Ç –º–µ–¥–∏–∞'; return; }
  const m=mediaArr[mediaIndex];
  mediaView.innerHTML=m.type.startsWith('image')?`<img src="${m.url}">`:`<video src="${m.url}" controls autoplay></video>`;
}

// –û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
document.querySelector('.add-btn').onclick=()=>{
  currentId=null;
  titleInput.value=''; textInput.value='';
  mediaArr=[]; mediaIndex=0;
  showMedia();
  modal.classList.add('active');
};

closeModal.onclick=()=>modal.classList.remove('active');

document.getElementById('save').onclick=async()=>{
  if(!titleInput.value.trim()) return;
  await addNote({ title:titleInput.value, text:textInput.value, media:mediaArr });
  modal.classList.remove('active');
  render();
};

document.getElementById('delete').onclick=async()=>{
  if(currentId!==null){
    await deleteNote(currentId);
    modal.classList.remove('active');
    render();
  }
};

async function render(filter=''){
  const notes=await getAllNotes();
  notesEl.innerHTML='';
  notes.forEach(n=>{
    if(n.title.toLowerCase().includes(filter)||n.text.toLowerCase().includes(filter)){
      const d=document.createElement('div');
      d.className='note';
      d.innerHTML=`<h4>${n.title}</h4>`;
      d.onclick=()=>openNote(n);
      notesEl.appendChild(d);
    }
  });
}

function openNote(n){
  currentId=n.id;
  titleInput.value=n.title;
  textInput.value=n.text;
  mediaArr=[...n.media];
  mediaIndex=0;
  showMedia();
  modal.classList.add('active');
}

// –ü–æ–∏—Å–∫
document.querySelector('.search').oninput=e=>render(e.target.value.toLowerCase());

// –°–≤–∞–π–ø –∑–∞–∫—Ä—ã—Ç–∏–µ
let startX=0;
card.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; });
card.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-startX;
  if(dx<-80) modal.classList.remove('active');
});

openDB().then(render);
</script>

</body>
</html>